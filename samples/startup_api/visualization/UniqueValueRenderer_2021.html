<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>はじめての Web アプリケーション開発 2021：データ可視化編（個別値分類）</title>
  <!--
    次のサンプルをアレンジ：
    https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=intro-layers
  -->
  <!-- ArcGIS API for JavaScript の参照 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.21/"></script>
  <!-- スタイル設定 -->
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #layerToggle {
      top: 20px;
      right: 20px;
      position: absolute;
      z-index: 99;
      background-color: white;
      border-radius: 8px;
      padding: 10px;
      opacity: 0.75;
    }
    .esri-legend__service-label{
      display:none;
    }
   
    
  </style>

  <script>
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/WebTileLayer",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend"
      ],
      (
        Map, 
        MapView, 
        WebTileLayer, 
        FeatureLayer, 
        Legend
      ) => {
        
        /**********************************************************************************
        * 
        * それぞれの値のシンボルを定義
        * 
        **********************************************************************************/  
        //住宅地のシンボルを定義
        const residenceSym = {
          type: "simple-marker",
          color: "#ED5151",
          size: 7,
          outline: {
            color: "#999999",
            width: 1
          }
        };

        //商業地域のシンボルを定義
        const commercialAreaSym = {
          type: "simple-marker",
          color: "#149ECE",
          size: 7,
          outline: {
            color: "#999999",
            width: 1
          }
        };

        //工業地域のシンボルを定義
        const industorialZoneaSym = {
          type: "simple-marker",
          color: "#A7C636",
          size: 7,
          outline: {
            color: "#999999",
            width: 1
          }
        };

        //その他のシンボルを定義
        const otherSym = {
          type: "simple-marker",
          color: "#AAAAAA",
          size: 7,
          outline: {
            color: "#999999",
            width: 1
          }
        };

        /**********************************************************************************
        * 
        * レンダラーを定義
        * 
        **********************************************************************************/  
        //レンダラーを定義
        const renderer = {
          type: "unique-value",
          field: "L01_001", //標準値コード
          defaultSymbol: otherSym,
          defaultLabel: "その他",
          //それぞれの値で使用するシンボルを割り当てる
          // "codedValues"はjsonで確認
          // https://services.arcgis.com/wlVTGRSYTzAbjjiC/ArcGIS/rest/services/LandPrice/FeatureServer/0?f=pjson
          // "000" : "住宅地" , 
          // "003" : "宅地見込地" ,
          // "005" : "商業地" ,
          // "007" : "準工業地" ,
          // "009" : "工業地" ,
          // "010" : "市街化調整区域内の現況宅地" ,
          // "013" : "市街化調整区域内の現況林地" ,
          uniqueValueInfos: [{
            value: "000",　//000:住宅地
            symbol: residenceSym,
            label: "住宅地"
          },{
            value: "005", //005:商業地
            symbol: commercialAreaSym,
            label: "商業地"
          },{
            value: "009",　//009:工業地
            symbol: industorialZoneaSym,
            label: "工業地"
          }]
        };
        
        /**********************************************************************************
         * 1つのWebTileLayer と 2つのFeatureLayer のインスタンスを作成
         * 1) WebTileLayer:地理院タイル（淡色地図）
         *    地理院タイル一覧ページ：https://maps.gsi.go.jp/development/ichiran.html
         * 2) FeatureLayer:公示地価 Living Atlas
         * 3) FeatureLayer:全国市区町村界データ 2021 Living Atlas
         **********************************************************************************/  

        // WebTileLayer:地理院タイル（淡色地図）
        // 地理院タイルの形式から WebTileLayer への読み換え
        // 【読み換え前】https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png
        // 【読み換え後】https://cyberjapandata.gsi.go.jp/xyz/pale/{level}/{col}/{row}.png
        const gsipaleLyr = new WebTileLayer({
            urlTemplate:"https://cyberjapandata.gsi.go.jp/xyz/pale/{level}/{col}/{row}.png",
            id:"gsipale",
            opacity:0.9,
            copyright:"地理院タイル（淡色地図）",
            visible: false
        });

        // FeatureLayer：公示地価(国土数値情報 調査時点:令和3年1月1日)： Living Atlas
        const chikakojiLyr = new FeatureLayer({
            url: "https://services.arcgis.com/wlVTGRSYTzAbjjiC/arcgis/rest/services/LandPrice/FeatureServer/0",
            id: "chikakoji",
            //上で作成したレンダラーを適用する
            renderer: renderer,
            // 2021にデータを変更したことに伴いレイヤーが愛知県のみとなるようフィルタ定義を追加
            definitionExpression: "L01_021 LIKE '23%'"
        });
        
        // FeatureLayer：全国市区町村界データ 2021： Living Atlas
        const cityareaLyr = new FeatureLayer({
            url: "https://services.arcgis.com/wlVTGRSYTzAbjjiC/arcgis/rest/services/municipalityboundaries2021/FeatureServer",
            id: "cityarea",
            opacity: 0.5,
            minScale: 5000000,//1500000,　パフォーマンスが向上しているのでスケール変更
            maxScale: 50000,
            visible: false,
            // 上記と同様にこちらも愛知県のみになるようフィルタ定義を追加
            definitionExpression: "JCODE LIKE '23%'"
        });

        /**********************************************************************************
         * 
         * Map の作成と レイヤー の追加
         * 
         **********************************************************************************/  
        // Map を作成
        // コンストラクター内でレイヤーを追加
        const map = new Map({
          basemap: "streets",
          layers: [chikakojiLyr]
        });
        // もしくは map.add() を使って map にレイヤーを追加することも可能
        map.add(cityareaLyr, 0);
        map.add(gsipaleLyr, 0);
        
        // MapView を作成し map インスタンスを追加
        const view = new MapView({  
          container: "viewDiv",
          map: map
        });

         // 凡例ウィジェットを作成
         const legend = new Legend({
          view: view,
          leyerInfos: [chikakojiLyr]
        });
        view.ui.add(legend,"bottom-right");

        
        /**********************************************************************************
         * view の ”layerview-create” イベントで
         * コンソール内でそれらのプロパティを確認できるよう print 文で出力
         **********************************************************************************/
        view.on("layerview-create", function(event) {
          if (event.layer.id === "gsipale") {
            // gsipaleLyr view のプロパティを確認できる
            console.log("地理院タイル（淡色地図）の LayerView が作成されました!", event.layerView);
          }
          if (event.layer.id === "chikakoji"){
            // chikakojiLyr view のプロパティを確認できる
            console.log("地価公示 の LayerView が作成されました!", event.layerView);
          }
          if (event.layer.id === "cityarea"){
            // cityLyr view のプロパティを確認できる
            console.log("全国市区町村界データ の LayerView が作成されました!", event.layerView);
          }
        });
        /**********************************************************************************
         * ロードされた時 もしくは すべてのプロパティにアクセスできるようになったとき
         * layer.when('callback') で指定されるコールバック関数が実行される
         * 
         * 地価公示レイヤーがロードされると、view が初期表示範囲として
         * レイヤーの表示範囲にズームしながら移動していく処理
         **********************************************************************************/
        view.when(function() {
            chikakojiLyr.when(() => {
                return chikakojiLyr.queryExtent();
            }).then((response) => {
                // goTo のアニメーションの動きを調整するため、GoToOptions2D のduration にデフォルトの10倍の値を設定
                // https://developers.arcgis.com/javascript/latest/api-reference/esri-views-MapView.html#methods-summary
                view.goTo(response.extent, {"duration":2000}); 
            });
        });
        
        const gsipaleToggle = document.getElementById("gsipaleLyr");
        const chikakojiToggle = document.getElementById("chikakojiLyr");
        const cityareaToggle = document.getElementById("cityareaLyr");
        /**********************************************************************************
         * レイヤーの visible プロパティで view 内でのレイヤーの表示/非表示を切り替えを行う
         * なお、レイヤーが非表示状態であっても、そのレイヤーのプロパティにアクセスしたり、
         * そのレイヤーに対して解析を実行することは可能
         **********************************************************************************/
        gsipaleToggle.addEventListener("change", () => {
          gsipaleLyr.visible = gsipaleToggle.checked;
        });
        chikakojiToggle.addEventListener("change", () => {
          chikakojiLyr.visible = chikakojiToggle.checked;
        });
        cityareaToggle.addEventListener("change", () => {
          cityareaLyr.visible = cityareaToggle.checked;
        });
      });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <span id="layerToggle">
    <input type="checkbox" id="gsipaleLyr" />地理院タイル-淡色地図(WebTileLayer)<br>
    <input type="checkbox" id="chikakojiLyr" checked />愛知県の地価公示(FeatureLayer)
    <input type="checkbox" id="cityareaLyr"  />全国市区町村界(FeatureLayer)
  </span>
  
</body>

</html>
